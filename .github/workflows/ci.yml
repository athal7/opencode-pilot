name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Verify JavaScript syntax
        run: |
          for file in plugin/*.js; do
            echo "Checking $file..."
            node --check "$file"
          done

      - name: Run tests
        run: ./test/run_tests.bash

  release:
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

  update-homebrew:
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.HOMEBREW_APP_ID }}
          private-key: ${{ secrets.HOMEBREW_APP_PRIVATE_KEY }}
          owner: athal7
          repositories: homebrew-tap

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: opencode-ntfy
          homebrew-tap: athal7/homebrew-tap
          tag-name: v${{ needs.release.outputs.new_release_version }}
          download-url: https://github.com/athal7/opencode-ntfy.git
          push-to: athal7/homebrew-tap
          base-branch: main
          create-pullrequest: false
          create-branch: false
          commit-message: |
            chore: bump {{formulaName}} to {{version}}
        env:
          COMMITTER_TOKEN: ${{ steps.app-token.outputs.token }}
