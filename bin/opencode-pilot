#!/usr/bin/env node
/**
 * opencode-pilot - CLI for opencode-pilot automation
 *
 * Commands:
 *   setup       Copy plugin files and configure OpenCode
 *   status      Show installation and service status
 *   poll        Start polling for issues/PRs to work on
 *   help        Show help
 */

import { fileURLToPath } from "url";
import { dirname, join } from "path";
import { existsSync, readFileSync, writeFileSync, mkdirSync, cpSync, rmSync } from "fs";
import { execSync } from "child_process";
import os from "os";

// Get script directory for relative imports
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Find service directory - check multiple locations for homebrew compatibility
function findServiceDir() {
  const candidates = [
    join(__dirname, "..", "service"),      // Development: bin/../service
    join(__dirname, "..", "libexec"),      // Homebrew: bin/../libexec
  ];
  for (const dir of candidates) {
    if (existsSync(join(dir, "poll-service.js"))) {
      return dir;
    }
  }
  return candidates[0];
}

// Find plugin directory
function findPluginDir() {
  const candidates = [
    join(__dirname, "..", "plugin"),                        // Development
    join(__dirname, "..", "lib", "opencode-pilot", "plugin"), // Homebrew
  ];
  for (const dir of candidates) {
    if (existsSync(join(dir, "index.js"))) {
      return dir;
    }
  }
  return null;
}

const serviceDir = findServiceDir();

// Paths
const OPENCODE_CONFIG_DIR = join(os.homedir(), ".config/opencode");
const PLUGIN_NAME = "opencode-pilot";
const PLUGIN_DEST = join(OPENCODE_CONFIG_DIR, "plugins", PLUGIN_NAME);
const OPENCODE_CONFIG_FILE = join(OPENCODE_CONFIG_DIR, "opencode.json");
const PILOT_CONFIG_FILE = join(os.homedir(), ".config/opencode-pilot/config.json");
const DEFAULT_REPOS_CONFIG = join(os.homedir(), ".config/opencode-pilot/repos.yaml");
const DEFAULT_STATE_PATH = join(os.homedir(), ".cache/opencode-pilot/poll-state.json");

// Parse command line arguments
function parseArgs(args) {
  const result = {
    command: null,
    subcommand: null,
    flags: {},
    positional: [],
  };

  let i = 0;
  while (i < args.length) {
    const arg = args[i];

    if (arg.startsWith("--")) {
      const key = arg.slice(2);
      if (i + 1 < args.length && !args[i + 1].startsWith("-")) {
        result.flags[key] = args[i + 1];
        i += 2;
      } else {
        result.flags[key] = true;
        i += 1;
      }
    } else if (arg.startsWith("-")) {
      const key = arg.slice(1);
      result.flags[key] = true;
      i += 1;
    } else if (!result.command) {
      result.command = arg;
      i += 1;
    } else if (!result.subcommand) {
      result.subcommand = arg;
      i += 1;
    } else {
      result.positional.push(arg);
      i += 1;
    }
  }

  return result;
}

// Help text
function showHelp() {
  console.log(`opencode-pilot - Automation layer for OpenCode

Usage:
  opencode-pilot <command> [options]

Commands:
  setup         Copy plugin files and configure OpenCode
  status        Show installation and service status
  poll          Start polling for issues/PRs to work on
  help          Show this help message

Setup copies the notification plugin to OpenCode and configures it.
Poll monitors GitHub/Linear for issues to work on automatically.

Examples:
  opencode-pilot setup               # Initial setup
  opencode-pilot status              # Check status
  opencode-pilot poll --dry-run      # Preview polling
`);
}

// ============================================================================
// Setup Command
// ============================================================================

async function setupCommand() {
  console.log("Setting up opencode-pilot...");
  console.log("");

  const pluginSource = findPluginDir();
  if (!pluginSource) {
    console.error("ERROR: Could not find plugin source files");
    console.error("Install via: brew install athal7/tap/opencode-pilot");
    process.exit(1);
  }

  console.log(`Source: ${pluginSource}`);
  console.log(`Destination: ${PLUGIN_DEST}`);
  console.log("");

  // Backup existing config
  if (existsSync(OPENCODE_CONFIG_FILE)) {
    const backupFile = `${OPENCODE_CONFIG_FILE}.backup.${Date.now()}`;
    try {
      cpSync(OPENCODE_CONFIG_FILE, backupFile);
      console.log(`Backup created: ${backupFile}`);
    } catch (err) {
      console.error("ERROR: Failed to create backup of opencode.json");
      process.exit(1);
    }
  }

  // Copy plugin files
  mkdirSync(join(OPENCODE_CONFIG_DIR, "plugins"), { recursive: true });
  if (existsSync(PLUGIN_DEST)) {
    rmSync(PLUGIN_DEST, { recursive: true });
  }
  cpSync(pluginSource, PLUGIN_DEST, { recursive: true });
  console.log("Plugin files copied.");

  // Update opencode.json
  let config = {};
  if (existsSync(OPENCODE_CONFIG_FILE)) {
    try {
      config = JSON.parse(readFileSync(OPENCODE_CONFIG_FILE, "utf8"));
    } catch {
      config = {};
    }
  }

  config.plugin = config.plugin || [];
  const alreadyRegistered = config.plugin.some(p => p.includes(`plugins/${PLUGIN_NAME}`));

  if (alreadyRegistered) {
    console.log("Plugin already in opencode.json");
  } else {
    config.plugin.push(PLUGIN_DEST);
    const tempFile = `${OPENCODE_CONFIG_FILE}.tmp`;
    writeFileSync(tempFile, JSON.stringify(config, null, 2) + "\n");
    const { renameSync } = await import("fs");
    renameSync(tempFile, OPENCODE_CONFIG_FILE);
    console.log("Added plugin to opencode.json");
  }

  // Try to restart service
  try {
    execSync("brew services restart opencode-pilot", { stdio: "pipe" });
    console.log("");
    console.log("Service restarted.");
  } catch {
    // Not installed via brew or service not available
  }

  console.log("");
  console.log("Setup complete!");
  console.log("");
  console.log("Configure notifications (optional):");
  console.log("  Set NTFY_TOPIC environment variable or in ~/.config/opencode-pilot/config.json");
}

// ============================================================================
// Status Command
// ============================================================================

function getConfigValue(envVar, configKey, defaultValue = "") {
  // Check env var first
  if (process.env[envVar]) {
    return process.env[envVar];
  }

  // Check config file
  if (existsSync(PILOT_CONFIG_FILE)) {
    try {
      const config = JSON.parse(readFileSync(PILOT_CONFIG_FILE, "utf8"));
      if (config[configKey] !== undefined && config[configKey] !== "") {
        return config[configKey];
      }
    } catch {
      // Ignore
    }
  }

  return defaultValue;
}

function statusCommand() {
  console.log("opencode-pilot status");
  console.log("=====================");
  console.log("");

  // Plugin installed?
  if (existsSync(PLUGIN_DEST)) {
    console.log(`Plugin: installed at ${PLUGIN_DEST}`);
  } else {
    console.log("Plugin: NOT INSTALLED (run: opencode-pilot setup)");
  }

  // Config?
  if (existsSync(OPENCODE_CONFIG_FILE)) {
    try {
      const config = JSON.parse(readFileSync(OPENCODE_CONFIG_FILE, "utf8"));
      const registered = (config.plugin || []).some(p => p.includes(`plugins/${PLUGIN_NAME}`));
      if (registered) {
        console.log("Config: plugin registered in opencode.json");
      } else {
        console.log("Config: plugin NOT in opencode.json");
      }
    } catch {
      console.log("Config: could not parse opencode.json");
    }
  } else {
    console.log("Config: opencode.json not found");
  }

  // Service running?
  try {
    const output = execSync("brew services list", { encoding: "utf8" });
    if (output.includes("opencode-pilot") && output.includes("started")) {
      console.log("Service: running");
    } else {
      console.log("Service: not running (run: brew services start opencode-pilot)");
    }
  } catch {
    console.log("Service: unknown (brew not available)");
  }

  // Notification configuration
  console.log("");
  console.log("Notification Configuration:");

  const topic = getConfigValue("NTFY_TOPIC", "topic", "");
  const server = getConfigValue("NTFY_SERVER", "server", "https://ntfy.sh");
  const callbackHost = getConfigValue("NTFY_CALLBACK_HOST", "callbackHost", "");
  const callbackPort = getConfigValue("NTFY_CALLBACK_PORT", "callbackPort", "4097");

  console.log(`  topic: ${topic || "<not set>"}`);
  console.log(`  server: ${server}`);
  console.log(`  callbackHost: ${callbackHost || "<not set>"}`);
  console.log(`  callbackPort: ${callbackPort}`);

  // Polling configuration
  console.log("");
  console.log("Polling Configuration:");
  if (existsSync(DEFAULT_REPOS_CONFIG)) {
    console.log(`  repos.yaml: ${DEFAULT_REPOS_CONFIG}`);
  } else {
    console.log("  repos.yaml: not found (polling disabled)");
  }
}

// ============================================================================
// Poll Command
// ============================================================================

function showPollHelp() {
  console.log(`opencode-pilot poll - Poll for issues/PRs to work on

Usage:
  opencode-pilot poll [options]
  opencode-pilot poll status

Options:
  --dry-run     Show what would be done without executing
  --once        Run one poll cycle and exit
  --config      Path to repos.yaml config file
  --interval    Poll interval in seconds (default: 300)

Subcommands:
  status        Show current WIP status and active sessions

Examples:
  opencode-pilot poll                    # Start polling loop
  opencode-pilot poll --dry-run          # Preview what would happen
  opencode-pilot poll status             # Show active sessions
`);
}

async function pollStatusCommand(flags) {
  const statePath = flags.state || DEFAULT_STATE_PATH;

  const { getWipStatus } = await import(join(serviceDir, "poll-service.js"));
  const status = getWipStatus(statePath);

  console.log("opencode-pilot poll status");
  console.log("==========================");
  console.log("");
  console.log(`Active sessions: ${status.count} / ${status.globalLimit}`);
  console.log("");

  if (status.activeSessions.length === 0) {
    console.log("No active sessions.");
  } else {
    console.log("Sessions:");
    for (const session of status.activeSessions) {
      console.log(`  - ${session.id} (${session.repo_key})`);
      console.log(`    Started: ${session.started_at}`);
    }
  }
}

async function pollCommand(flags, subcommand) {
  if (flags.help || flags.h) {
    showPollHelp();
    return;
  }

  if (subcommand === "status") {
    await pollStatusCommand(flags);
    return;
  }

  const configPath = flags.config || DEFAULT_REPOS_CONFIG;
  const statePath = flags.state || DEFAULT_STATE_PATH;
  const dryRun = flags["dry-run"] || false;
  const once = flags.once || false;
  const intervalSec = parseInt(flags.interval || "300", 10);

  if (!existsSync(configPath)) {
    console.error(`Config not found: ${configPath}`);
    console.error("");
    console.error("Create a repos.yaml config file at:");
    console.error(`  ${DEFAULT_REPOS_CONFIG}`);
    console.error("");
    console.error("See: https://github.com/athal7/opencode-pilot#configuration");
    process.exit(1);
  }

  const { pollOnce, startPolling, stopPolling } = await import(
    join(serviceDir, "poll-service.js")
  );

  if (once || dryRun) {
    console.log(`[poll] Running single poll cycle${dryRun ? " (dry-run)" : ""}...`);
    console.log(`[poll] Config: ${configPath}`);
    console.log("");

    const results = await pollOnce({ dryRun, configPath, statePath });

    if (results.length === 0) {
      console.log("[poll] No actions taken.");
    } else {
      console.log(`[poll] ${results.length} action(s) ${dryRun ? "would be" : ""} taken.`);
    }
  } else {
    console.log("[poll] Starting polling loop...");
    console.log(`[poll] Config: ${configPath}`);
    console.log(`[poll] Interval: ${intervalSec}s`);
    console.log("");

    startPolling({
      configPath,
      statePath,
      interval: intervalSec * 1000,
    });

    process.on("SIGINT", () => {
      console.log("\n[poll] Shutting down...");
      stopPolling();
      process.exit(0);
    });

    process.on("SIGTERM", () => {
      stopPolling();
      process.exit(0);
    });
  }
}

// ============================================================================
// Main
// ============================================================================

async function main() {
  const args = process.argv.slice(2);
  const { command, subcommand, flags } = parseArgs(args);

  if (!command || command === "help") {
    showHelp();
    return;
  }

  switch (command) {
    case "setup":
      await setupCommand();
      break;

    case "status":
      statusCommand();
      break;

    case "poll":
      await pollCommand(flags, subcommand);
      break;

    default:
      console.error(`Unknown command: ${command}`);
      console.error("");
      showHelp();
      process.exit(1);
  }
}

main().catch((err) => {
  console.error("Error:", err.message);
  process.exit(1);
});
