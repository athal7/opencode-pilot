#!/usr/bin/env node
/**
 * opencode-pilot - CLI for opencode-pilot automation
 *
 * Commands:
 *   poll        Start polling for issues/PRs to work on
 *   poll status Show current WIP status
 *   help        Show help
 */

import { fileURLToPath } from "url";
import { dirname, join } from "path";
import { existsSync } from "fs";
import os from "os";

// Get script directory for relative imports
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const serviceDir = join(__dirname, "..", "service");

// Default paths
const DEFAULT_CONFIG_PATH = join(
  os.homedir(),
  ".config/opencode-pilot/repos.yaml"
);
const DEFAULT_STATE_PATH = join(
  os.homedir(),
  ".cache/opencode-pilot/poll-state.json"
);

// Parse command line arguments
function parseArgs(args) {
  const result = {
    command: null,
    subcommand: null,
    flags: {},
    positional: [],
  };

  let i = 0;
  while (i < args.length) {
    const arg = args[i];

    if (arg.startsWith("--")) {
      const key = arg.slice(2);
      // Check if next arg is a value (not a flag)
      if (i + 1 < args.length && !args[i + 1].startsWith("-")) {
        result.flags[key] = args[i + 1];
        i += 2;
      } else {
        result.flags[key] = true;
        i += 1;
      }
    } else if (arg.startsWith("-")) {
      const key = arg.slice(1);
      result.flags[key] = true;
      i += 1;
    } else if (!result.command) {
      result.command = arg;
      i += 1;
    } else if (!result.subcommand) {
      result.subcommand = arg;
      i += 1;
    } else {
      result.positional.push(arg);
      i += 1;
    }
  }

  return result;
}

// Help text
function showHelp() {
  console.log(`opencode-pilot - Automation layer for OpenCode

Usage:
  opencode-pilot <command> [options]

Commands:
  poll          Start polling for issues/PRs to work on
  poll status   Show current WIP status
  help          Show this help message

Poll Options:
  --dry-run     Show what would be done without executing
  --once        Run one poll cycle and exit (don't start interval)
  --config      Path to repos.yaml config file
  --interval    Poll interval in seconds (default: 300)
  --state       Path to state file for WIP tracking

Examples:
  opencode-pilot poll                    # Start polling
  opencode-pilot poll --dry-run          # Preview actions
  opencode-pilot poll --once --dry-run   # Single dry-run cycle
  opencode-pilot poll status             # Show active sessions
`);
}

// Poll help
function showPollHelp() {
  console.log(`opencode-pilot poll - Poll for issues/PRs to work on

Usage:
  opencode-pilot poll [options]
  opencode-pilot poll status

Options:
  --dry-run     Show what would be done without executing
  --once        Run one poll cycle and exit (don't start interval)
  --config      Path to repos.yaml config file (default: ~/.config/opencode-pilot/repos.yaml)
  --interval    Poll interval in seconds (default: 300)
  --state       Path to state file for WIP tracking

Subcommands:
  status        Show current WIP status and active sessions

Examples:
  opencode-pilot poll                    # Start polling loop
  opencode-pilot poll --dry-run          # Preview what would happen
  opencode-pilot poll --once             # Run single poll cycle
  opencode-pilot poll status             # Show active sessions
`);
}

// Poll status command
async function pollStatus(flags) {
  const statePath = flags.state || DEFAULT_STATE_PATH;

  const { getWipStatus } = await import(join(serviceDir, "poll-service.js"));
  const status = getWipStatus(statePath);

  console.log("opencode-pilot poll status");
  console.log("==========================");
  console.log("");
  console.log(`Active sessions: ${status.count} / ${status.globalLimit}`);
  console.log("");

  if (status.activeSessions.length === 0) {
    console.log("No active sessions.");
  } else {
    console.log("Sessions:");
    for (const session of status.activeSessions) {
      console.log(`  - ${session.id} (${session.repo_key})`);
      console.log(`    Started: ${session.started_at}`);
    }
  }
}

// Poll command
async function pollCommand(flags, subcommand) {
  // Handle --help
  if (flags.help || flags.h) {
    showPollHelp();
    return;
  }

  // Handle status subcommand
  if (subcommand === "status") {
    await pollStatus(flags);
    return;
  }

  const configPath = flags.config || DEFAULT_CONFIG_PATH;
  const statePath = flags.state || DEFAULT_STATE_PATH;
  const dryRun = flags["dry-run"] || false;
  const once = flags.once || false;
  const intervalSec = parseInt(flags.interval || "300", 10);

  // Check if config exists
  if (!existsSync(configPath)) {
    console.error(`Config not found: ${configPath}`);
    console.error("");
    console.error("Create a repos.yaml config file at:");
    console.error(`  ${DEFAULT_CONFIG_PATH}`);
    console.error("");
    console.error("See: https://github.com/athal7/opencode-pilot#configuration");
    process.exit(1);
  }

  // Import poll service
  const { pollOnce, startPolling, stopPolling } = await import(
    join(serviceDir, "poll-service.js")
  );

  if (once || dryRun) {
    // Single poll cycle
    console.log(`[poll] Running single poll cycle${dryRun ? " (dry-run)" : ""}...`);
    console.log(`[poll] Config: ${configPath}`);
    console.log("");

    const results = await pollOnce({
      dryRun,
      configPath,
      statePath,
    });

    if (results.length === 0) {
      console.log("[poll] No actions taken.");
    } else {
      console.log(`[poll] ${results.length} action(s) ${dryRun ? "would be" : ""} taken.`);
    }
  } else {
    // Start polling loop
    console.log("[poll] Starting polling loop...");
    console.log(`[poll] Config: ${configPath}`);
    console.log(`[poll] Interval: ${intervalSec}s`);
    console.log("");

    const { interval } = startPolling({
      configPath,
      statePath,
      interval: intervalSec * 1000,
    });

    // Handle shutdown gracefully
    process.on("SIGINT", () => {
      console.log("");
      console.log("[poll] Shutting down...");
      stopPolling();
      process.exit(0);
    });

    process.on("SIGTERM", () => {
      stopPolling();
      process.exit(0);
    });
  }
}

// Main
async function main() {
  const args = process.argv.slice(2);
  const { command, subcommand, flags } = parseArgs(args);

  // Default to help
  if (!command || command === "help" || flags.help || flags.h) {
    showHelp();
    return;
  }

  switch (command) {
    case "poll":
      await pollCommand(flags, subcommand);
      break;

    default:
      console.error(`Unknown command: ${command}`);
      console.error("");
      showHelp();
      process.exit(1);
  }
}

main().catch((err) => {
  console.error("Error:", err.message);
  process.exit(1);
});
