#!/usr/bin/env bash
#
# opencode-ntfy - CLI for opencode-ntfy plugin management
#
set -euo pipefail

PLUGIN_NAME="opencode-ntfy"
OPENCODE_CONFIG_DIR="$HOME/.config/opencode"
PLUGIN_DEST="$OPENCODE_CONFIG_DIR/plugins/$PLUGIN_NAME"
CONFIG_FILE="$OPENCODE_CONFIG_DIR/opencode.json"

# Find plugin source - check Homebrew first, then local
find_plugin_source() {
  # Homebrew install
  local brew_prefix
  if brew_prefix="$(brew --prefix opencode-ntfy 2>/dev/null)"; then
    if [[ -d "$brew_prefix/lib/opencode-ntfy/plugin" ]]; then
      echo "$brew_prefix/lib/opencode-ntfy/plugin"
      return 0
    fi
  fi
  
  # Local development (script is in bin/, plugin is in plugin/)
  local script_dir
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -d "$script_dir/../plugin" ]]; then
    echo "$script_dir/../plugin"
    return 0
  fi
  
  return 1
}

cmd_setup() {
  echo "Setting up $PLUGIN_NAME..."
  echo ""
  
  # Find source
  local plugin_source
  if ! plugin_source="$(find_plugin_source)"; then
    echo "ERROR: Could not find plugin source files"
    echo "Install via: brew install athal7/tap/opencode-ntfy"
    exit 1
  fi
  
  echo "Source: $plugin_source"
  echo "Destination: $PLUGIN_DEST"
  echo ""
  
  # Copy plugin files
  mkdir -p "$OPENCODE_CONFIG_DIR/plugins"
  rm -rf "$PLUGIN_DEST"
  cp -r "$plugin_source" "$PLUGIN_DEST"
  echo "Plugin files copied."
  
  # Update opencode.json
  if [[ -f "$CONFIG_FILE" ]]; then
    if grep -q "plugins/$PLUGIN_NAME" "$CONFIG_FILE" 2>/dev/null; then
      echo "Plugin already in opencode.json"
    else
      # Add plugin to existing config
      node -e "
        const fs = require('fs');
        const config = JSON.parse(fs.readFileSync('$CONFIG_FILE', 'utf8'));
        config.plugin = config.plugin || [];
        if (!config.plugin.some(p => p.includes('plugins/$PLUGIN_NAME'))) {
          config.plugin.push('$PLUGIN_DEST');
        }
        fs.writeFileSync('$CONFIG_FILE', JSON.stringify(config, null, 2) + '\n');
      "
      echo "Added plugin to opencode.json"
    fi
  else
    mkdir -p "$OPENCODE_CONFIG_DIR"
    echo '{"plugin": ["'"$PLUGIN_DEST"'"]}' | node -e "
      const fs = require('fs');
      let input = '';
      process.stdin.on('data', d => input += d);
      process.stdin.on('end', () => {
        fs.writeFileSync('$CONFIG_FILE', JSON.stringify(JSON.parse(input), null, 2) + '\n');
      });
    "
    echo "Created opencode.json with plugin configured"
  fi
  
  # Start service (Homebrew only)
  if brew --prefix opencode-ntfy &>/dev/null; then
    echo ""
    echo "Starting callback service..."
    brew services restart opencode-ntfy
    echo ""
    echo "Service started. View logs with:"
    echo "  tail -f \$(brew --prefix)/var/log/opencode-ntfy.log"
  fi
  
  echo ""
  echo "Setup complete!"
  echo ""
  echo "Required: Set NTFY_TOPIC in your environment or opencode.json"
  echo "Optional: Set NTFY_CALLBACK_HOST for interactive permissions"
}

NTFY_CONFIG_FILE="$HOME/.config/opencode-ntfy/config.json"

# Read a value from config file (JSON)
read_config_value() {
  local key="$1"
  if [[ -f "$NTFY_CONFIG_FILE" ]]; then
    node -e "
      const fs = require('fs');
      try {
        const config = JSON.parse(fs.readFileSync('$NTFY_CONFIG_FILE', 'utf8'));
        if (config['$key'] !== undefined && config['$key'] !== '') {
          console.log(config['$key']);
        }
      } catch (e) {}
    " 2>/dev/null
  fi
}

# Get effective config value (env var > config file > default)
get_config() {
  local env_var="$1"
  local config_key="$2"
  local default_value="${3:-}"
  
  # Check env var first
  local env_value="${!env_var:-}"
  if [[ -n "$env_value" ]]; then
    echo "$env_value"
    return
  fi
  
  # Check config file
  local file_value
  file_value=$(read_config_value "$config_key")
  if [[ -n "$file_value" ]]; then
    echo "$file_value"
    return
  fi
  
  # Return default
  echo "$default_value"
}

cmd_status() {
  echo "opencode-ntfy status"
  echo "===================="
  echo ""
  
  # Plugin installed?
  if [[ -d "$PLUGIN_DEST" ]]; then
    echo "Plugin: installed at $PLUGIN_DEST"
  else
    echo "Plugin: NOT INSTALLED (run: opencode-ntfy setup)"
  fi
  
  # Config?
  if [[ -f "$CONFIG_FILE" ]] && grep -q "plugins/$PLUGIN_NAME" "$CONFIG_FILE" 2>/dev/null; then
    echo "Config: plugin registered in opencode.json"
  else
    echo "Config: plugin NOT in opencode.json"
  fi
  
  # Service running?
  if brew services list 2>/dev/null | grep -q "opencode-ntfy.*started"; then
    echo "Service: running"
  else
    echo "Service: not running (run: brew services start opencode-ntfy)"
  fi
  
  # Configuration (from config file and/or environment)
  echo ""
  echo "Configuration:"
  
  local topic server callback_host callback_port
  topic=$(get_config "NTFY_TOPIC" "topic" "")
  server=$(get_config "NTFY_SERVER" "server" "https://ntfy.sh")
  callback_host=$(get_config "NTFY_CALLBACK_HOST" "callbackHost" "")
  callback_port=$(get_config "NTFY_CALLBACK_PORT" "callbackPort" "4097")
  
  if [[ -n "$topic" ]]; then
    echo "  topic: $topic"
  else
    echo "  topic: <not set>"
  fi
  
  echo "  server: $server"
  
  if [[ -n "$callback_host" ]]; then
    echo "  callbackHost: $callback_host"
  else
    echo "  callbackHost: <not set>"
  fi
  
  echo "  callbackPort: $callback_port"
  
  # Show config file status
  echo ""
  if [[ -f "$NTFY_CONFIG_FILE" ]]; then
    echo "Config file: $NTFY_CONFIG_FILE"
  else
    echo "Config file: not found ($NTFY_CONFIG_FILE)"
  fi
}

cmd_help() {
  cat <<EOF
opencode-ntfy - ntfy notification plugin for OpenCode

Usage:
  opencode-ntfy <command>

Commands:
  setup     Copy plugin files and start service
  status    Show installation and service status
  help      Show this help message

Examples:
  opencode-ntfy setup    # Initial setup after brew install
  opencode-ntfy status   # Check if everything is configured
EOF
}

# Main
case "${1:-help}" in
  setup)  cmd_setup ;;
  status) cmd_status ;;
  help|--help|-h) cmd_help ;;
  *)
    echo "Unknown command: $1"
    echo ""
    cmd_help
    exit 1
    ;;
esac
